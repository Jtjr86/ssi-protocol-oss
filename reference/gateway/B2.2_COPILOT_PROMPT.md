# Track B2.2: JWT Authentication - Copilot Prompt

**Copy this into Copilot Chat in `reference/gateway`:**

---

Track B2.2: JWT authentication (Cloud-only)

Context:
- Track B2.1 complete: API key auth via x-api-key header (tenant-scoped, EXIT 0)
- Current auth precedence: API key → x-tenant-id → default
- Test tenants exist: tenant-alpha, tenant-beta (seeded in dev via 002a_seed_dev_tenants.sql)
- **Do not rename existing tables/columns; inspect current schema and match naming (rpx_entries, tenants, api_keys, etc.)**

Goal:
1) Create src/auth/jwtAuth.ts middleware:
   - Extract Authorization: Bearer <token> header
   - If absent: call next() (fall through to API key auth)
   - Verify JWT using jsonwebtoken.verify(token, JWT_SECRET)
   - Expected JWT payload structure:
     ```typescript
     {
       sub: string;          // User ID (required)
       tenant_id: string;    // Tenant ID (required)
       role: string;         // Role (required: 'viewer', 'auditor', 'admin')
       exp: number;          // Expiry timestamp (required)
       iat: number;          // Issued at timestamp
     }
     ```
   - If valid: attach req.auth = { tenant_id, role, auth_method: 'jwt', sub }
   - If expired: return 401 { error: 'TOKEN_EXPIRED' }
   - If invalid signature: return 401 { error: 'INVALID_TOKEN' }
   - If malformed: return 401 { error: 'MALFORMED_TOKEN' }
   - Export TypeScript interface: JwtPayload extending AuthContext

2) Update src/server.ts:
   - Import jwtAuthMiddleware
   - Apply JWT middleware BEFORE API key middleware:
     ```typescript
     app.use(jwtAuthMiddleware);      // Try JWT first
     app.use(apiKeyAuthMiddleware);   // Fall back to API key
     ```
   - Tenant extraction middleware (already exists) will use req.auth from either JWT or API key
   - No changes to /v1/decisions protection (already requires auth unless ENABLE_INSECURE_DEV)

3) Update .env.example (or document in ENV_SETUP.md):
   - Add JWT_SECRET environment variable
   - Example: JWT_SECRET=your-256-bit-secret-here
   - Production: Use openssl rand -hex 32 to generate

4) Create scripts/jwt_auth_test.ts:
   - Test 1: POST /v1/decisions with valid JWT (tenant-alpha/auditor) → 200 OK
     - Generate JWT with: { sub: 'user-1', tenant_id: 'tenant-alpha', role: 'auditor', exp: now + 1 hour }
     - Header: Authorization: Bearer <token>
     - Verify response.success = true and response.rpx_id exists
   
   - Test 2: POST /v1/decisions with expired JWT → 401 TOKEN_EXPIRED
     - Generate JWT with: exp: now - 1 hour (expired)
     - Header: Authorization: Bearer <token>
   
   - Test 3: POST /v1/decisions with invalid signature → 401 INVALID_TOKEN
     - Generate JWT with wrong secret
     - Header: Authorization: Bearer <token>
   
   - Test 4: Missing JWT + valid API key still works (no regression)
     - No Authorization header
     - Header: x-api-key: ssi_test_auditor_key_alpha_2024
     - Verify API key auth still works (200 OK)
   
   - Test 5: JWT tenant overrides x-tenant-id header
     - Header: Authorization: Bearer <token with tenant-alpha>
     - Header: x-tenant-id: tenant-beta (WRONG tenant)
     - Verify response uses tenant-alpha (JWT wins)
   
   - Exit 0 if all pass, exit 1 if any fail
   - Print clear test results with ✅/❌ markers

Output exact files to create/modify:
- src/auth/jwtAuth.ts (new middleware file)
- src/server.ts (UPDATED - add JWT middleware before API key)
- scripts/jwt_auth_test.ts (new test file)
- Optional: Update ENV_SETUP.md to document JWT_SECRET

Use existing AuthContext interface from apiKeyAuth.ts. Match existing code style in server.ts.

---

**After Copilot generates code:**
1. Apply all changes
2. Install jsonwebtoken: `npm install jsonwebtoken @types/jsonwebtoken`
3. Set JWT_SECRET env var (in Gateway PowerShell window or .env file):
   ```powershell
   $env:JWT_SECRET='dev_secret_key_256_bit_minimum_length_required_here_1234567890'
   ```
4. Rebuild: `npm run build`
5. Restart Gateway (in PowerShell window):
   ```powershell
   # Ctrl+C to stop
   $env:ENABLE_INSECURE_DEV='true'
   $env:JWT_SECRET='dev_secret_key_256_bit_minimum_length_required_here_1234567890'
   npm start
   ```
6. Run tests:
   ```powershell
   npx ts-node scripts\jwt_auth_test.ts
   npx ts-node scripts\auth_api_key_test.ts  # No regression
   npx ts-node scripts\tenant_isolation_test.ts  # No B1 regression
   ```
7. Report results (must be EXIT 0 for all)
