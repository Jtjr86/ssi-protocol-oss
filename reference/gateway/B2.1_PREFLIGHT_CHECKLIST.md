# B2.1 Pre-Flight Checklist (Review BEFORE Accepting Copilot Code)

**Use this checklist to validate Copilot's generated code before applying.**

---

## ğŸªŸ Pre-Execution Gotchas (Before Running Copilot)

### **Gotcha 1: Windows + bcrypt**
On Windows, `bcrypt` may fail to install (node-gyp / Visual Studio Build Tools issues).

**Solution:** Use `bcryptjs` (pure JS, no native compilation) as fallback:
```bash
npm install bcryptjs @types/bcryptjs
```

**Update imports in apiKeyAuth.ts:**
```typescript
import bcrypt from "bcryptjs";  // Instead of "bcrypt"
```

### **Gotcha 2: Gateway env var loading**
Confirm Gateway loads environment variables:

**Option A - PowerShell window (current approach):**
```powershell
$env:ENABLE_INSECURE_DEV='true'  # Set in Gateway PowerShell window before npm start
npm start
```

**Option B - .env file:**
Verify `dotenv` is loaded in server.ts:
```typescript
import 'dotenv/config';  // Must be first import
```

**Note:** If using `.env`, confirm it's in `.gitignore` (already is).

---

## ğŸ” Guardrail 1: Dev Seed Safety

**Check `sql/003a_seed_dev_api_keys.sql`:**

- [ ] âœ… Plaintext keys ONLY in SQL comments (not in INSERT statements)
- [ ] âœ… Comments clearly state: "DO NOT USE IN PRODUCTION" or "DEV ONLY"
- [ ] âœ… File name has `a` suffix (003**a**) indicating dev-only seed
- [ ] âŒ No real/production API keys committed anywhere

**Example GOOD pattern:**
```sql
-- DEV-ONLY TEST KEYS (DO NOT RUN IN PRODUCTION):
-- tenant-alpha (auditor): dev_key_alpha_auditor_123
-- tenant-beta (viewer):   dev_key_beta_viewer_456

INSERT INTO api_keys (key_prefix, key_hash, tenant_id, role)
VALUES 
  ('dev_key_alph', '<bcrypt-hash>', 'tenant-alpha', 'auditor'),
  ('dev_key_beta', '<bcrypt-hash>', 'tenant-beta', 'viewer');
```

---

## âš¡ Guardrail 2: Fast Lookup (No Full-Table Scan)

**Check `src/auth/apiKeyAuth.ts`:**

- [ ] âœ… Computes `key_prefix = apiKey.substring(0, 12)` FIRST
- [ ] âœ… Queries by `WHERE key_prefix = $1` (indexed lookup)
- [ ] âœ… Only bcrypt.compare against returned candidates (usually 1-2 rows max)
- [ ] âŒ Does NOT query all active keys then iterate

**Example GOOD pattern:**
```typescript
const keyPrefix = apiKey.substring(0, 12);

const candidates = await query<{
  key_hash: string;
  tenant_id: string;
  role: string;
  expires_at: string | null;
}>(
  `SELECT key_hash, tenant_id, role, expires_at
   FROM api_keys
   WHERE key_prefix = $1 AND is_active = true
   AND (expires_at IS NULL OR expires_at > NOW())`,
  [keyPrefix]
);

// bcrypt.compare only against this small candidate set
for (const candidate of candidates.rows) {
  if (await bcrypt.compare(apiKey, candidate.key_hash)) {
    // Match found!
  }
}
```

**Example BAD pattern (REJECT):**
```typescript
// âŒ WRONG: Queries all keys, then iterates
const allKeys = await query('SELECT * FROM api_keys WHERE is_active = true');
for (const key of allKeys.rows) {
  if (await bcrypt.compare(apiKey, key.key_hash)) { ... }
}
```

---

## ğŸ§± Guardrail 3: Tenant Override (Prevent Spoofing)

**Check `src/server.ts` tenant extraction middleware:**

- [ ] âœ… If `req.auth` exists â†’ use `req.auth.tenant_id` (API key wins)
- [ ] âœ… Else â†’ fallback to `x-tenant-id` header OR `'default'`
- [ ] âŒ Does NOT trust `x-tenant-id` when API key is present

**Example GOOD pattern:**
```typescript
app.use((req, res, next) => {
  const auth = (req as any).auth as AuthContext | undefined;
  
  if (auth) {
    // API key tenant overrides header
    (req as any).tenant_id = auth.tenant_id;
  } else {
    // Fallback to header or default
    (req as any).tenant_id = (req.headers['x-tenant-id'] as string) || 'default';
  }
  
  next();
});
```

**Example BAD pattern (REJECT):**
```typescript
// âŒ WRONG: Allows header to override API key
(req as any).tenant_id = (req.headers['x-tenant-id'] as string) 
  || auth?.tenant_id 
  || 'default';
```

---

## ğŸ§­ Guardrail 4: Endpoint Auth Requirements

**Check `src/server.ts` route protection:**

- [ ] âœ… `POST /v1/decisions` requires `req.auth` OR `ENABLE_INSECURE_DEV=true`
- [ ] âœ… Returns 401 if neither condition met
- [ ] âœ… `/v1/audit/verify*` endpoints remain open (no auth required yet)
- [ ] âŒ Does NOT apply auth globally (per-route control)

**Example GOOD pattern:**
```typescript
app.post('/v1/decisions', (req, res, next) => {
  const auth = (req as any).auth as AuthContext | undefined;
  const insecureDevMode = process.env.ENABLE_INSECURE_DEV === 'true';
  
  if (!auth && !insecureDevMode) {
    res.status(401).json({ error: 'AUTHENTICATION_REQUIRED' });
    return;
  }
  next();
}, async (req, res) => {
  // ... existing handler
});
```

---

## ğŸªŸ Guardrail 5: Environment Variable Scope

**Before running tests:**

- [ ] âœ… Set `ENABLE_INSECURE_DEV=true` in Gateway's PowerShell window (before `npm start`)
- [ ] âœ… OR add to `.env` file in `reference/gateway/`
- [ ] âŒ Do NOT set in test script window only (won't affect Gateway process)

**Recommended: Create `.env` file:**
```bash
# reference/gateway/.env (for local dev only)
DATABASE_URL=postgres://ssi_user:ssi_password@localhost:5432/ssi_cloud
SIGNING_SEED=INSECURE_DEV_SEED
PORT=4040
KERNEL_URL=http://localhost:5050/v1/evaluate
ENABLE_INSECURE_DEV=true
```

Then Gateway automatically loads it on `npm start`.

---

## âœ… Final Validation Checklist

**Before committing:**

- [ ] âœ… All 5 guardrails passed
- [ ] âœ… `auth_api_key_test.ts` â†’ EXIT 0
- [ ] âœ… `tenant_isolation_test.ts` â†’ EXIT 0 (no regression)
- [ ] âœ… Gateway rebuilt: `npm run build`
- [ ] âœ… No TypeScript errors
- [ ] âœ… No SQL migration errors
- [ ] âœ… Test keys inserted in dev database
- [ ] âœ… Ready for commit (use exact commit message from guardrails doc)

---

## ğŸš« Reject Code If Any of These Are True

- âŒ Queries all API keys then iterates (Guardrail 2 violation)
- âŒ Trusts `x-tenant-id` header when API key present (Guardrail 3 violation)
- âŒ Applies auth globally via `app.use()` without per-route control (Guardrail 4 violation)
- âŒ Creates a `roles` table (that's B2.3, not B2.1)
- âŒ Adds JWT logic (that's B2.2, not B2.1)
- âŒ Modifies protocol kernel code
- âŒ Changes Track A+ verification logic

---

## âœ… Ready to Execute

**If all guardrails check out:**
1. Apply Copilot's code
2. Follow Steps 4-10 in execution sequence
3. Post EXIT 0 results for commit approval

**If any guardrail fails:**
1. Reject that part of Copilot's code
2. Clarify constraint in Copilot Chat
3. Request regeneration
4. Re-validate against checklist
