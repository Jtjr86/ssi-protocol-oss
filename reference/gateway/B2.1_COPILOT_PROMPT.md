# Track B2.1: API Key Authentication - Copilot Prompt

**Copy this into Copilot Chat in `reference/gateway`:**

---

Track B2.1: API key authentication (Cloud-only)

Context:
- Track A+ exists: /v1/audit/verify and /v1/audit/verify-chain endpoints
- Track B1 complete: tenant isolation enforced via tenant_id (FK to tenants table)
- Current auth: x-tenant-id header OR default to 'default' (backwards compatible)
- Test tenants exist: tenant-alpha, tenant-beta (seeded in dev via 002a_seed_dev_tenants.sql)
- **Do not rename existing tables/columns; inspect current schema and match naming (rpx_entries, tenants, etc.)**

Goal:
1) Create SQL migration 003_add_api_key_auth.sql:
   - Table: api_keys (
       key_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
       key_prefix TEXT NOT NULL,
       key_hash TEXT UNIQUE NOT NULL,
       tenant_id TEXT NOT NULL REFERENCES tenants(tenant_id),
       role TEXT NOT NULL,
       created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
       is_active BOOLEAN NOT NULL DEFAULT true,
       expires_at TIMESTAMPTZ NULL,
       description TEXT
     )
   - Index: idx_api_keys_prefix_active (key_prefix, is_active, expires_at)
   - Index: idx_api_keys_tenant (tenant_id)
   - NO roles table yet (defer to B2.3)
   - Use TEXT for role column (values: 'viewer', 'auditor', 'admin')

2) Create src/auth/apiKeyAuth.ts middleware:
   - Extract x-api-key header
   - If absent: call next() (fall through to x-tenant-id)
   - Compute prefix = first 12 chars of apiKey
   - Query candidates:
     SELECT key_hash, tenant_id, role, expires_at
     FROM api_keys
     WHERE key_prefix = $1 AND is_active = true
       AND (expires_at IS NULL OR expires_at > NOW())
   - bcrypt.compare(apiKey, key_hash) over returned candidates (usually 1-2 results max)
   - If match found: attach req.auth = { tenant_id, role, auth_method: 'api_key' }
   - If no match: return 401 { error: 'INVALID_API_KEY' }
   - Export TypeScript interface: AuthContext { tenant_id: string; role: string; auth_method: string }

3) Update src/server.ts:
   - Import apiKeyAuthMiddleware and AuthContext
   - Apply globally BEFORE routes: app.use(apiKeyAuthMiddleware)
   - Add tenant_id extraction middleware (runs after auth):
     ```typescript
     app.use((req, res, next) => {
       const auth = (req as any).auth as AuthContext | undefined;
       if (auth) {
         (req as any).tenant_id = auth.tenant_id;
       } else {
         (req as any).tenant_id = (req.headers['x-tenant-id'] as string) || 'default';
       }
       next();
     });
     ```
   - Protect /v1/decisions route specifically (NOT global):
     ```typescript
     app.post('/v1/decisions', (req, res, next) => {
       const auth = (req as any).auth as AuthContext | undefined;
       const insecureDevMode = process.env.ENABLE_INSECURE_DEV === 'true';
       
       if (!auth && !insecureDevMode) {
         res.status(401).json({ error: 'AUTHENTICATION_REQUIRED' });
         return;
       }
       next();
     }, async (req, res) => {
       // ... existing /v1/decisions handler
     });
     ```
   - Do NOT modify /v1/audit/* routes yet (leave open for now)

4) Install dependencies:
   - npm install bcrypt @types/bcrypt

5) Create sql/003a_seed_dev_api_keys.sql (dev-only):
   - Generate bcrypt hashes for test API keys (use bcrypt.hashSync with cost 10)
   - Insert 2 test keys:
     * Key: dev_key_alpha_auditor_123 → tenant-alpha, role: auditor
       - key_prefix: 'dev_key_alph' (first 12 chars)
       - key_hash: <bcrypt hash>
     * Key: dev_key_beta_viewer_456 → tenant-beta, role: viewer
       - key_prefix: 'dev_key_beta' (first 12 chars)
       - key_hash: <bcrypt hash>
   - Include SQL comments with plaintext keys for test suite reference:
     ```sql
     -- Plaintext test keys (DO NOT USE IN PRODUCTION):
     -- tenant-alpha (auditor): dev_key_alpha_auditor_123
     -- tenant-beta (viewer):   dev_key_beta_viewer_456
     ```

6) Create scripts/auth_api_key_test.ts:
   - Test 1: POST /v1/decisions with valid x-api-key (tenant-alpha/auditor) → 200 OK
     - Header: x-api-key: dev_key_alpha_auditor_123
     - Request: { client_id: 'test', system_id: 'trading-prod', action: { type: 'trade.order.place', payload: { notional: 5000 } } }
     - Verify response.success = true and response.rpx_id exists
   - Test 2: POST /v1/decisions with invalid x-api-key → 401 INVALID_API_KEY
     - Header: x-api-key: invalid_key_999
   - Test 3: POST /v1/decisions without x-api-key and ENABLE_INSECURE_DEV=true → 200 OK (backwards compat)
     - No x-api-key header
     - Header: x-tenant-id: default
     - Verify it still works (dev mode bypass)
   - Test 4: GET /v1/audit/verify/:rpx_id with valid x-api-key (tenant-beta/viewer) → 200 OK
     - Use rpx_id from Test 1
     - Header: x-api-key: dev_key_beta_viewer_456
     - Should work (audit endpoints not auth-gated yet)
   - Test 5: Verify x-tenant-id header ignored when x-api-key present
     - Header: x-api-key: dev_key_alpha_auditor_123
     - Header: x-tenant-id: tenant-beta (WRONG tenant)
     - Verify response uses tenant-alpha (API key wins)
   - Exit 0 if all pass, exit 1 if any fail
   - Print clear test results with ✅/❌ markers

Output exact files to create/modify:
- sql/003_add_api_key_auth.sql (prod migration)
- sql/003a_seed_dev_api_keys.sql (dev seed with plaintext keys in comments)
- src/auth/apiKeyAuth.ts (new middleware file)
- src/server.ts (UPDATED - add auth middleware + protect /v1/decisions)
- scripts/auth_api_key_test.ts (new test file)

Use existing db.ts query() function for database access. Match existing code style in server.ts and rpxClient.ts.

---

**After Copilot generates code:**
1. Apply all changes
2. Install bcrypt: `npm install bcrypt @types/bcrypt`
   - **Windows fallback:** If bcrypt fails (node-gyp issues), use `npm install bcryptjs @types/bcryptjs` and update imports to `import bcrypt from "bcryptjs"`
3. Apply migrations:
   ```powershell
   Get-Content sql\003_add_api_key_auth.sql | docker compose exec -T postgres psql -U ssi_user -d ssi_cloud
   Get-Content sql\003a_seed_dev_api_keys.sql | docker compose exec -T postgres psql -U ssi_user -d ssi_cloud
   ```
4. **Sanity check database:**
   ```powershell
   # 1) Confirm api_keys table exists
   docker compose exec -T postgres psql -U ssi_user -d ssi_cloud -c "\d api_keys"
   
   # 2) Confirm dev keys seeded (should show 2 rows)
   docker compose exec -T postgres psql -U ssi_user -d ssi_cloud -c "SELECT key_prefix, tenant_id, role, is_active, expires_at FROM api_keys ORDER BY created_at DESC;"
   ```
5. Rebuild: `npm run build`
6. Restart Gateway (in PowerShell window):
   ```powershell
   # Ctrl+C to stop
   $env:ENABLE_INSECURE_DEV='true'  # Set env var in THIS window before npm start
   npm start
   ```
   **Note:** Verify Gateway loads `.env` file if using (check for `import 'dotenv/config'` in server.ts)
7. Run tests:
   ```powershell
   npx ts-node scripts\auth_api_key_test.ts
   npx ts-node scripts\tenant_isolation_test.ts  # No regression
   ```
8. Report results (must be EXIT 0 for both)
