version: '3.8'

services:
  kernel:
    build:
      context: ..
      dockerfile: docker/kernel.Dockerfile
    image: ssiprotocol/kernel:v0.3.0
    container_name: ssi-kernel
    ports:
      - "5050:5050"
    environment:
      - NODE_ENV=production
      - PORT=5050
    volumes:
      # Mount custom envelopes if needed
      - ./envelopes:/app/envelopes:ro
    restart: unless-stopped
    networks:
      - ssi-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5050/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  gateway:
    build:
      context: ..
      dockerfile: docker/gateway.Dockerfile
    image: ssiprotocol/gateway:v0.3.0
    container_name: ssi-gateway
    ports:
      - "4040:4040"
    environment:
      - NODE_ENV=production
      - PORT=4040
      - KERNEL_URL=http://kernel:5050
    volumes:
      # Mount RPX audit log directory
      - rpx-data:/app/rpx
    depends_on:
      kernel:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - ssi-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4040/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  rpx-data:
    driver: local

networks:
  ssi-network:
    driver: bridge
